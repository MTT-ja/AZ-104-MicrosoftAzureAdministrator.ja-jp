---
lab:
  title: 06 - トラフィック管理を実装する
  module: Module 06 - Network Traffic Management
ms.openlocfilehash: a88449e01cf33631baefb1b6ce99ce82028bbc20
ms.sourcegitcommit: be14e4ff5bc638e8aee13ec4b8be29525d404028
ms.translationtype: HT
ms.contentlocale: ja-JP
ms.lasthandoff: 05/11/2022
ms.locfileid: "144937807"
---
# <a name="lab-06---implement-traffic-management"></a>ラボ 06 - トラフィック管理を実装する
# <a name="student-lab-manual"></a>受講生用ラボ マニュアル

## <a name="lab-scenario"></a>ラボのシナリオ

ハブおよびスポーク ネットワーク トポロジの Azure 仮想マシンを対象としたネットワーク トラフィックの管理テストを担当していましたが、Contoso は Azure 環境での実装を検討しています (前のラボでテストしたメッシュ トポロジを作成する代わりに)。 このテストでは、ハブを経由してトラフィックを強制的に流すユーザー定義ルートに依存してスポーク間の接続を実装する必要があり、また、レイヤ 4 およびレイヤ 7 ロード バランサーを使用して仮想マシン間でのトラフィック分散を行う必要があります。 この目的のために、Azure Load Balancer (レイヤー 4) と Azure Application Gateway (レイヤー 7) を使用する予定です。

>**注**:このラボでは、デフォルトで、Standard_D2s_v3 SKU の Azure VM のデプロイが 4 つ含まれるため、デプロイ用に選択したリージョンの Standard_Dsv3 シリーズで使用可能な vCPU が合計 8 個必要です。 受講生が試用版アカウントを使用しており、vCPU が 4 つに制限されている場合は、1 つの vCPU のみを必要とする VM サイズ (Standard_B1s など) を使用できます。

## <a name="objectives"></a>目標

このラボでは、次のことを行います。

+ タスク 1:ラボ環境をプロビジョニングする
+ タスク 2: ハブ アンド スポーク ネットワーク トポロジを構成する
+ タスク 3: 仮想ネットワーク ピアリングの推移性をテストする
+ タスク 4: ハブ アンド スポーク トポロジでルーティングを構成する
+ タスク 5:Azure Load Balancer を実装する
+ タスク 6:Azure Application Gateway を実装する

## <a name="estimated-timing-60-minutes"></a>推定時間:60 分

## <a name="architecture-diagram"></a>アーキテクチャの図

![image](../media/lab06.png)


## <a name="instructions"></a>Instructions

### <a name="exercise-1"></a>演習 1

#### <a name="task-1-provision-the-lab-environment"></a>タスク 1:ラボ環境をプロビジョニングする

このタスクでは、同じ Azure リージョンに 4 つの仮想マシンをデプロイします。 最初の 2 つはハブバーチャル ネットワークに存在し、残りはそれぞれ別個のスポークバーチャル ネットワークに存在します。

1. [Azure portal](https://portal.azure.com) にサインインします。

1. Azure portal の右上にあるアイコンをクリックして **Azure Cloud Shell** を開きます。

1. **Bash** または **PowerShell** の選択を求めるメッセージが表示されたら、 **[PowerShell]** を選択します。

    >**注**:**Cloud Shell** の初回起動時に **「ストレージがマウントされていません」** というメッセージが表示された場合は、このラボで使用しているサブスクリプションを選択し、 **「ストレージの作成」** を選択します。

1. [Cloud Shell] ペインのツールバーで、 **[ファイルのアップロード/ダウンロード]** アイコンをクリックし、ドロップダウン メニューで **[アップロード]** をクリックして、ファイル **\\Allfiles\\Labs\\06\\az104-06-vms-loop-template.json** と **\\Allfiles\\Labs\\06\\az104-06-vms-loop-parameters.json** を Cloud Shell のホーム ディレクトリにアップロードします。

1. アップロードしたばかりの **パラメーター** ファイルを編集し、パスワードを変更します。 シェルでのファイルの編集に関してヘルプが必要な場合は、インストラクターに相談してください。 ベスト プラクティスとして、パスワードなどのシークレットは、キー コンテナーに安全に保存する必要があります。 

1. [Cloud Shell] ペインから次を実行して、ラボ環境をホストする最初のリソース グループを作成します (`[Azure_region]` プレースホルダーを、Azure Virtual Machines をデプロイする Azure リージョンの名前に置き換えます)("(Get-AzLocation).Location" コマンドレットを使用して、リージョン一覧を取得できます)。

    ```powershell 
    $location = '[Azure_region]'
    ```
    
    ここで、リソース グループ名は次のようになります。
    ```powershell
    $rgName = 'az104-06-rg1'
    ```
    
    最後に、目的の場所にリソース グループを作成します。
    ```powershell
    New-AzResourceGroup -Name $rgName -Location $location
    ```


1. 「Cloud Shell」 ウィンドウで、次のコマンドを実行して 3 つのバーチャル ネットワークを作成し、アップロードしたテンプレートとパラメーター ファイルを使用して、4 つの Azure VM を作成します。

   ```powershell
   New-AzResourceGroupDeployment `
      -ResourceGroupName $rgName `
      -TemplateFile $HOME/az104-06-vms-loop-template.json `
      -TemplateParameterFile $HOME/az104-06-vms-loop-parameters.json
   ```

    >**注**: デプロイが完了するまで待ってから、次の手順に進んでください。 これには 5 分ほどかかります。

    >**注**:VM サイズが利用できないというエラーが発生した場合、インストラクターにサポートを依頼し、次の手順を試してください。
    > 1. CloudShell で `{}` ボタンをクリックし、左側のバーから **az104-06-vms-loop-parameters.json** を選択して、`vmSize` パラメーターの値をメモしておきます。
    > 1. "az104-04-rg1" リソース グループがデプロイされている場所を確認します。 CloudShell で `az group show -n az104-04-rg1 --query location` を実行して、それを取得することができます。
    > 1. CloudShell で `az vm list-skus --location <Replace with your location> -o table --query "[? contains(name,'Standard_D2s')].name"` を実行します。
    > 1. `vmSize` パラメーターの値を、先ほど実行したコマンドによって返された値のいずれかに置き換えます。 値が返されない場合は、必要に応じて別のリージョンを選んでデプロイする必要があります。 また、"Standard_B1s" のような別のファミリ名を選ぶこともできます。
    > 1. 次に、`New-AzResourceGroupDeployment` コマンドを再度実行して、テンプレートを再デプロイします。 上方向ボタンを数回押して、最後に実行されたコマンドを上に持ってくることができます。

1. Cloud Shell ウィンドウから、以下を実行して、前の手順でデプロイされた Azure VM に Network Watcher 拡張機能をインストールします。

   ```powershell
   $rgName = 'az104-06-rg1'
   $location = (Get-AzResourceGroup -ResourceGroupName $rgName).location
   $vmNames = (Get-AzVM -ResourceGroupName $rgName).Name

   foreach ($vmName in $vmNames) {
     Set-AzVMExtension `
     -ResourceGroupName $rgName `
     -Location $location `
     -VMName $vmName `
     -Name 'networkWatcherAgent' `
     -Publisher 'Microsoft.Azure.NetworkWatcher' `
     -Type 'NetworkWatcherAgentWindows' `
     -TypeHandlerVersion '1.4'
   }
   ```

    >**注**: デプロイが完了するまで待ってから、次の手順に進んでください。 これには 5 分ほどかかります。



1. [Cloud Shell] ペインを閉じます。

#### <a name="task-2-configure-the-hub-and-spoke-network-topology"></a>タスク 2: ハブ アンド スポーク ネットワーク トポロジを構成する

このタスクでは、前のタスクで展開したバーチャル ネットワーク間のローカル ピアリングを構成して、ハブとスポークのネットワーク トポロジを作成します。

1. Azure portal で、 **[仮想ネットワーク]** を検索して選択します。

1. 前のタスクで作成したバーチャル ネットワークを確認します。

    >**注**:3 つのバーチャル ネットワークのデプロイに使用したテンプレートに、3 つのバーチャル ネットワークの IP アドレス範囲が重複しないようにします。

1. バーチャル ネットワークのリストで、 **「az104-06-vnet2」** を選択します。

1. 「**az104-06-vnet2**」 ブレードで 「**プロパティ**」 を選択します。 

1. **[az104-06-vnet2 \| プロパティ]** ブレードで、 **[リソース ID]** プロパティの値を記録します。

1. バーチャル ネットワークのリストに戻り、 **「az104-06-vnet3」** を選択します。

1. **[az104-06-vnet3]** ブレードで、 **[プロパティ]** を選択します。 

1. **[az104-06-vnet3 \| プロパティ]** ブレードで、 **[リソース ID]** プロパティの値を記録します。

    >**注**:このタスクの後半で、両方のバーチャル ネットワークの ResourceID プロパティの値が必要になります。

    >**注**:これは、バーチャル ネットワーク ピアリングを作成するときに、Azure Portal が新しくプロビジョニングされたバーチャル ネットワークを表示しないことがあるという問題に対処する回避策です。

1. 仮想ネットワークの一覧で、 **[az104-06-vnet01]**

1. **[az104-06-vnet01]** 仮想ネットワーク ブレードの **[設定]** セクションで、 **[ピアリング]** をクリックしてから、 **[+ 追加]** をクリックします。

1. 次の設定でピアリングを追加し (他のユーザーには既定値を残します)、 **「追加」** をクリックします。

    | 設定 | 値 |
    | --- | --- |
    | この仮想ネットワーク: ピアリング リンク名 | **az104-06-vnet01_to_az104-06-vnet2** |
    | [Traffic to remote virtual network](リモート仮想ネットワークへのトラフィック) | **許可 (既定)** |
    | [Traffic forwarded from remote virtual network](リモート仮想ネットワークから転送されるトラフィック) | **この仮想ネットワークの外部から発信されるトラフィックをブロックする** |
    | 仮想ネットワーク ゲートウェイ | **なし (既定値)** |
    | リモート仮想ネットワーク: ピアリング リンク名 | **az104-06-vnet2_to_az104-06-vnet01** |
    | 仮想ネットワークのデプロイ モデル | **リソース マネージャー** |
    | リソース ID を知っている | enabled |
    | Resource ID | このタスクの前半で記録した **az104-06-vnet2** の resourceID パラメーターの値 |
    | [Traffic to remote virtual network](リモート仮想ネットワークへのトラフィック) | **許可 (既定)** |
    | [Traffic forwarded from remote virtual network](リモート仮想ネットワークから転送されるトラフィック) | **許可 (既定)** |
    | 仮想ネットワーク ゲートウェイ | **なし (既定値)** |

    >**注**: 操作が完了するまで待ちます。

    >**注**:この手順では、1 つは az104-06-vnet01 から az104-06-vnet2、もう 1 つは az104-06-vnet2 から az104-06-vnet01 への 2 つのグローバル ピアリングを確立します。

    >**注**: このラボで後ほど実装するスポーク仮想ネットワーク間のルーティングを容易にするために、 **[トラフィック転送を許可する]** を有効にする必要があります。

1. **[az104-06-vnet01]** 仮想ネットワーク ブレードの **[設定]** セクションで、 **[ピアリング]** をクリックしてから、 **[+ 追加]** をクリックします。

1. 次の設定でピアリングを追加し (他のユーザーには既定値を残します)、 **「追加」** をクリックします。

    | 設定 | 値 |
    | --- | --- |
    | この仮想ネットワーク: ピアリング リンク名 | **az104-06-vnet01_to_az104-06-vnet3** |
    | [Traffic to remote virtual network](リモート仮想ネットワークへのトラフィック) | **許可 (既定)** |
    | [Traffic forwarded from remote virtual network](リモート仮想ネットワークから転送されるトラフィック) | **この仮想ネットワークの外部から発信されるトラフィックをブロックする** |
    | 仮想ネットワーク ゲートウェイ | **なし (既定値)** |
    | リモート仮想ネットワーク: ピアリング リンク名 | **az104-06-vnet3_to_az104-06-vnet01** |
    | 仮想ネットワークのデプロイ モデル | **リソース マネージャー** |
    | リソース ID を知っている | enabled |
    | Resource ID | このタスクの前半で記録した **az104-06-vnet3** の resourceID パラメーターの値 |
    | [Traffic to remote virtual network](リモート仮想ネットワークへのトラフィック) | **許可 (既定)** |
    | [Traffic forwarded from remote virtual network](リモート仮想ネットワークから転送されるトラフィック) | **許可 (既定)** |
    | 仮想ネットワーク ゲートウェイ | **なし (既定値)** |

    >**注**:この手順では、1 つは az104-06-vnet01 から az104-06-vnet3、もう 1 つは az104-06-vnet3 から az104-06-vnet01 への 2 つのグローバル ピアリングを確立します。 これで、ハブとスポーク トポロジの設定が完了します (2 つのスポークバーチャル ネットワークを使用)。

    >**注**: このラボで後ほど実装するスポーク仮想ネットワーク間のルーティングを容易にするために、 **[トラフィック転送を許可する]** を有効にする必要があります。

#### <a name="task-3-test-transitivity-of-virtual-network-peering"></a>タスク 3: 仮想ネットワーク ピアリングの推移性をテストする

このタスクでは、Network Watcher を使用してバーチャル ネットワーク ピアリングの推移性をテストします。

1. Azure portal で、「**Network Watcher**」を検索して選びます。

1. **[Network Watcher]** ブレードで、Azure リージョンの一覧を展開し、使用しているリージョンでサービスが有効になっていることを確認します。 

1. **「Network Watcher」** ブレードで、 **「接続のトラブルシューティング」** に移動します。

1. **「Network Watcher - 接続のトラブルシューティング」** ブレードで、次の設定でチェックを開始します (その他の設定は既定値のままにします)。

    | 設定 | 値 |
    | --- | --- |
    | サブスクリプション | このラボで使用している Azure サブスクリプションの名前 |
    | リソース グループ | **az104-06-rg1** |
    | 送信元の種類 | **仮想マシン** |
    | 仮想マシン | **az104-06-vm0** |
    | 宛先 | **手動で指定** |
    | URI、FQDN、または IPv4 | **10.62.0.4** |
    | Protocol | **TCP** |
    | 宛先ポート | **3389** |

    > **注**:**10.62.0.4** は、プライベート IP アドレス **az104-06-vm2** を表します。

1. **「確認」** をクリックし、接続チェックの結果が返されるまで待ちます。 状態が "**到達可能**" であることを確認します。 ネットワーク パスを確認します。接続が直接であり、仮想マシン間に中間ホップがないことに注意してください。

    > **注**:ハブバーチャル ネットワークは最初のスポークバーチャル ネットワークと直接ピアリングされるため、これは予期されます。

1. **「Network Watcher - 接続のトラブルシューティング」** ブレードで、次の設定でチェックを開始します (その他の設定は既定値のままにします)。

    | 設定 | 値 |
    | --- | --- |
    | サブスクリプション | このラボで使用している Azure サブスクリプションの名前 |
    | リソース グループ | **az104-06-rg1** |
    | 送信元の種類 | **仮想マシン** |
    | 仮想マシン | **az104-06-vm0** |
    | 宛先 | **手動で指定** |
    | URI、FQDN、または IPv4 | **10.63.0.4** |
    | Protocol | **TCP** |
    | 宛先ポート | **3389** |

    > **注**:**10.63.0.4** は、プライベート IP アドレス **az104-06-vm3** を表します。

1. **「確認」** をクリックし、接続チェックの結果が返されるまで待ちます。 状態が "**到達可能**" であることを確認します。 ネットワーク パスを確認します。接続が直接であり、仮想マシン間に中間ホップがないことに注意してください。

    > **注**:ハブバーチャル ネットワークは 2 番目のスポークバーチャル ネットワークと直接ピアリングされるため、これは予期されます。

1. **「Network Watcher - 接続のトラブルシューティング」** ブレードで、次の設定でチェックを開始します (その他の設定は既定値のままにします)。

    | 設定 | 値 |
    | --- | --- |
    | サブスクリプション | このラボで使用している Azure サブスクリプションの名前 |
    | リソース グループ | **az104-06-rg1** |
    | 送信元の種類 | **仮想マシン** |
    | 仮想マシン | **az104-06-vm2** |
    | 宛先 | **手動で指定** |
    | URI、FQDN、または IPv4 | **10.63.0.4** |
    | Protocol | **TCP** |
    | 宛先ポート | **3389** |

1. **「確認」** をクリックし、接続チェックの結果が返されるまで待ちます。 状態が "**到達不能**" であることに注意してください。

    > **注**:これは、2 つのスポークバーチャル ネットワークが互いにピアリングされないので、予想されます (バーチャル ネットワーク ピアリングは推移的ではありません)。

#### <a name="task-4-configure-routing-in-the-hub-and-spoke-topology"></a>タスク 4: ハブ アンド スポーク トポロジでルーティングを構成する

このタスクでは、**az104-06-vm0** 仮想マシンのネットワーク インターフェイスで IP 転送を有効にし、オペレーティング システム内でルーティングを有効にし、スポークバーチャル ネットワーク上でユーザー定義のルートを構成することにより、2 つのスポークバーチャル ネットワーク間のルーティングを構成およびテストします。

1. Azure portal で、「**仮想マシン**」を検索して選びます。

1. **「仮想マシン」** ブレードの仮想マシンのリストで、 **「az104-06-vm0」** をクリックします。

1. **「az104-06-vm0** 仮想マシン」 ブレードの **「設定」** セクションで、 **「ネットワーク」** をクリックします。

1. **「ネットワーク インターフェイス」** ラベルの横の **「az104-06-nic0」** リンクをクリックし、 **「az104-06-nic0」** ネットワーク インターフェイス ブレードの **「設定」** セクションで **「IP 構成」** をクリックします。

1. **「IP 転送」** を **「有効」** に設定し、変更を保存します。

   > **注**:この設定は、2 つのスポークバーチャル ネットワーク間でトラフィックをルーティングするルーターとして **az104-06-vm0** が機能するために必要です。

   > **注**:ここで、ルーティングをサポートするように **az104-06-vm0** 仮想マシンのオペレーティング システムを構成する必要があります。

1. Azure portal で、 **「az104-06-vm0** Azure 仮想マシン」 ブレードに戻り、 **「概要」** をクリックします。

1. **az104-06-vm0** ブレードの **[操作]** セクションで、 **[コマンドの実行]** をクリックし、コマンドの一覧で **RunPowerShellScript** を選択します。

1. **「コマンド スクリプトの実行」** ブレードで、次のコマンドを入力し、 **「実行」** をクリックしてリモート アクセス Windows サーバー ロールをインストールします。

   ```powershell
   Install-WindowsFeature RemoteAccess -IncludeManagementTools
   ```

   > **注**: コマンドが正常に完了したことの確認を待ちます。

1. **「コマンド スクリプトの実行」** ブレードで、次のコマンドを入力し、 **「実行」** をクリックしてルーティング ロール サービスをインストールします。

   ```powershell
   Install-WindowsFeature -Name Routing -IncludeManagementTools -IncludeAllSubFeature

   Install-WindowsFeature -Name "RSAT-RemoteAccess-Powershell"

   Install-RemoteAccess -VpnType RoutingOnly

   Get-NetAdapter | Set-NetIPInterface -Forwarding Enabled
   ```

   > **注**: コマンドが正常に完了したことの確認を待ちます。

   > **注**:次に、スポークバーチャル ネットワーク上でユーザー定義のルートを作成および構成する必要があります。

1. Azure portal で **「ルート テーブル」** を検索して選択し、 **「ルート テーブル」** ブレードで **「+ 作成」** をクリックします。

1. 次の設定でルート テーブルを作成します (その他は既定値のままにします)。

    | 設定 | 値 |
    | --- | --- |
    | サブスクリプション | このラボで使用している Azure サブスクリプションの名前 |
    | リソース グループ | **az104-06-rg1** |
    | 場所 | 仮想ネットワークを作成した Azure リージョンの名前 |
    | 名前 | **az104-06-rt23** |
    | ゲートウェイのルートを伝達する | **No** |

1. **[確認と作成]** をクリックします。 検証を実行し、 **「作成」** をクリックしてデプロイを送信します。

   > **注**: ルートテーブルが作成されるまで待ちます。 これには 3 分ほどかかります。

1. **[リソースに移動]** をクリックします。

1. **「az104-06-rt23** ルート テーブル」 ブレードの **「設定」** セクションで **「ルート」** をクリックしてから、 **「+ 追加」** をクリックします。

1. 次の設定を使って新しいルートを追加します。

    | 設定 | 値 |
    | --- | --- |
    | ルート名 | **az104-06-route-vnet2-to-vnet3** |
    | アドレス プレフィックス ソース | **[IP アドレス]** |
    | ソース IP アドレス/CIDR 範囲 | **10.63.0.0/20** |
    | ネクストホップの種類 | **仮想アプライアンス** |
    | 次ホップ アドレス | **10.60.0.4** |

1. **[OK]**

1. **「az104-06-rt23** ルート テーブル」 ブレードの **「設定」** セクションで **「サブネット」** をクリックしてから、 **「+ 関連付け」** をクリックします。

1. ルート テーブル **「az104-06-rt23」** を次のサブネットに関連付けます。

    | 設定 | 値 |
    | --- | --- |
    | 仮想ネットワーク | **az104-06-vnet2** |
    | サブネット | **subnet0** |

1. **[OK]**

1. **「ルート テーブル」** ブレードに戻り、 **「+ 作成」** をクリックします。

1. 次の設定でルート テーブルを作成します (その他は既定値のままにします)。

    | 設定 | 値 |
    | --- | --- |
    | サブスクリプション | このラボで使用している Azure サブスクリプションの名前 |
    | リソース グループ | **az104-06-rg1** |
    | リージョン | 仮想ネットワークを作成した Azure リージョンの名前 |
    | 名前 | **az104-06-rt32** |
    | ゲートウェイのルートを伝達する | **No** |

1. 「確認と作成」 をクリックします。 検証を実行し、 「作成」 をクリックしてデプロイを送信します。

   > **注**: ルートテーブルが作成されるまで待ちます。 これには 3 分ほどかかります。

1. **[リソースに移動]** をクリックします。

1. **az104-06-rt32** ルート テーブル ブレードの **[設定]** セクションで、 **[ルート]** をクリックし、 **[+ 追加]** をクリックします。

1. 次の設定を使って新しいルートを追加します。

    | 設定 | 値 |
    | --- | --- |
    | ルート名 | **az104-06-route-vnet3-to-vnet2** |
    | アドレス プレフィックス ソース | **[IP アドレス]** |
    | ソース IP アドレス/CIDR 範囲 | **10.62.0.0/20** |    
    | ネクストホップの種類 | **仮想アプライアンス** |
    | 次ホップ アドレス | **10.60.0.4** |

1. **[OK]**

1. **az104-06-rt32** ルート テーブル ブレードに戻り、 **[設定]** セクションで **[サブネット]** をクリックし、 **[+ 関連付け]** をクリックします。

1. ルート テーブル **az104-06-rt32** を次のサブネットに関連付けます。

    | 設定 | 値 |
    | --- | --- |
    | 仮想ネットワーク | **az104-06-vnet3** |
    | サブネット | **subnet0** |

1. **[OK]**

1. Azure portal で、 **「Network Watcher - 接続トラブルシューティング」** ブレードに戻ります。

1. **「Network Watcher - 接続のトラブルシューティング」** ブレードで、次の設定でチェックを開始します (その他の設定は既定値のままにします)。

    | 設定 | 値 |
    | --- | --- |
    | サブスクリプション | このラボで使用している Azure サブスクリプションの名前 |
    | リソース グループ | **az104-06-rg1** |
    | 送信元の種類 | **仮想マシン** |
    | 仮想マシン | **az104-06-vm2** |
    | 宛先 | **手動で指定** |
    | URI、FQDN、または IPv4 | **10.63.0.4** |
    | Protocol | **TCP** |
    | 宛先ポート | **3389** |

1. **「確認」** をクリックし、接続チェックの結果が返されるまで待ちます。 状態が "**到達可能**" であることを確認します。 ネットワーク パスを確認し、トラフィックが **az104-06-nic0** ネットワーク アダプターに割り当てられた **10.60.0.4** を経由してルーティングされたことを確認します。 状態が **到達不能** の場合は、az104-06-vm0 を再起動する必要があります。

    > **注**:これは想定どおりの結果です。スポークバーチャル ネットワーク間のトラフィックは、ルーターとして機能するハブバーチャル ネットワークにある仮想マシンを経由してルーティングされるためです。

    > **注**:**Network Watcher** を使用して、ネットワークのトポロジを表示できます。

#### <a name="task-5-implement-azure-load-balancer"></a>タスク 5:Azure Load Balancer を実装する

このタスクでは、ハブバーチャル ネットワーク内の 2 つの Azure 仮想マシンの前に Azure Load Balancer を実装します。

1. Azure portal で **「ロード バランサー」** を検索して選択し、 **「ロード バランサー」** ブレードで **「+ 作成」** をクリックします。

1. 次の設定でロード バランサーを作成し (その他の設定は既定値のままにします)、 **[次へ: フロントエンド IP 構成]** をクリックします。

    | 設定 | 値 |
    | --- | --- |
    | サブスクリプション | このラボで使用している Azure サブスクリプションの名前 |
    | リソース グループ | **az104-06-rg1** |
    | 名前 | **az104-06-lb4** |
    | リージョン| このラボでその他のすべてのリソースをデプロイした Azure リージョンの名前 |
    | SKU | **Standard** |
    | Type | **Public** |
    
1. **[フロントエンド IP 構成]** タブで、 **[フロントエンド IP 構成の追加]** をクリックし、次の設定を使用してから **[追加]** をクリックします。   
     
    | 設定 | 値 |
    | --- | --- |
    | 名前 | 任意の一意の名前 |
    | パブリック IP アドレス | **新規作成** |
    | パブリック IP アドレス名 | **az104-06-pip4** |

1. **[確認と作成]** をクリックします。 検証を実行し、 **「作成」** をクリックしてデプロイを送信します。

    > **注**:Azure Load Balancer がプロビジョニングされるのを待ちます。 これには 2 分ほどかかります。

1. デプロイ ブレードで **「リソースに移動」** をクリックします。

1. **「az104-06-lb4** ロード バランサー」 ブレードの **「設定」** セクションで **「バックエンド プール」** をクリックしてから、 **「+ 追加」** をクリックします。

1. 次の設定でバックエンド プールを追加します (その他は既定値のままにします)。

    | 設定 | 値 |
    | --- | --- |
    | 名前 | **az104-06-lb4-be1** |
    | 仮想ネットワーク | **az104-06-vnet01** |
    | IP バージョン | **IPv4** |
    | 仮想マシン | **az104-06-vm0** |
    | 仮想マシンの IP アドレス | **ipconfig1 (10.60.0.4)** |
    | 仮想マシン | **az104-06-vm1** |
    | 仮想マシンの IP アドレス | **ipconfig1 (10.60.1.4)** |

1. **[追加]** をクリックします。

1. バックエンド プールが作成されるのを待ち、 **「設定」** セクションで、 **「正常性プローブ」** をクリックして、 **「+ 追加」** をクリックします。

1. 次の設定で正常性プローブを追加する:

    | 設定 | 値 |
    | --- | --- |
    | 名前 | **az104-06-lb4-hp1** |
    | Protocol | **TCP** |
    | Port | **80** |
    | Interval | **5** |
    | 異常のしきい値 | **2** |

1. **[追加]** をクリックします。

1. 正常性プローブが作成されるのを待ち、 **「設定」** セクションで、 **「負荷分散ルール」** をクリックして、 **「+ 追加」** をクリックします。

1. 次の設定で負荷分散規則を追加します (その他は既定値のままにします)。

    | 設定 | 値 |
    | --- | --- |
    | 名前 | **az104-06-lb4-lbrule1** |
    | IP バージョン | **IPv4** |
    | フロントエンド IP アドレス | **ドロップダウンから [LoadBalancerFrontEnd] を選択する**
    | Protocol | **TCP** |
    | Port | **80** |
    | バックエンド ポート | **80** |
    | バックエンド プール | **az104-06-lb4-be1** |
    | 正常性プローブ | **az104-06-lb4-hp1** |
    | セッション永続化 | **なし** |
    | アイドル タイムアウト (分) | **4** |
    | TCP リセット | **Disabled** |
    | フローティング IP (ダイレクト サーバー リターン) | **Disabled** |

1. **[追加]** をクリックします。

1. 負荷分散規則が作成されるのを待ってから、 **[設定]** セクションで **[フロントエンド IP 構成]** をクリックし、 **[パブリック IP アドレス]** の値をメモします。

1. 別のブラウザーのウィンドウを起動し、前の手順で識別した IP アドレスに移動します。

1. ブラウザー ウィンドウに、 **「az104-06-vm0 から Hello World」** または **「az104-06-vm1 から Hello World」** というメッセージが表示されることを確認します。

1. 別のブラウザー ウィンドウを開きますが、今回は InPrivate モードを使用して、ターゲット VM が (メッセージで示されているように) 変更するかどうかを確認します。

    > **注**:ブラウザー ウィンドウを更新するか、InPrivate モードを使用して再度開く必要があります。

#### <a name="task-6-implement-azure-application-gateway"></a>タスク 6:Azure Application Gateway を実装する

このタスクでは、スポークバーチャル ネットワーク内の 2 つの Azure 仮想マシンの前に Azure Application Gateway を実装します。

1. Azure portal で、 **「Virtual networks」** を検索して選択します。

1. バーチャル ネットワークのリストで **「バーチャル ネットワーク」** ブレードで、 **「az104-06-vnet01」** をクリックします。

1. **「az104-06-vnet01」** バーチャル ネットワーク ブレードの **「設定」** セクションで、 **「サブネット」** をクリックし、 **「+ サブネット」** をクリックします。

1. 次の設定でサブネットを追加します (その他の設定は既定値のままにします)。

    | 設定 | 値 |
    | --- | --- |
    | 名前 | **subnet-appgw** |
    | サブネットのアドレス範囲 | **10.60.3.224/27** |

1. **[保存]**

    > **注**:このサブネットは、このタスクの後半でデプロイする Azure Application Gateway インスタンスで使用されます。 Application Gateway には、/27 以上のサイズの専用サブネットが必要です。

1. Azure portal で **「アプリケーション ゲートウェイ」** を検索して選択し、 **「アプリケーション ゲートウェイ」** ブレードで **「+ 作成」** をクリックします。

1. **「Application Gateway 作成」** ブレードの **「基本」** タブで、次の設定を指定します (その他は既定値のままにします)。

    | 設定 | 値 |
    | --- | --- |
    | サブスクリプション | このラボで使用している Azure サブスクリプションの名前 |
    | リソース グループ | **az104-06-rg1** |
    | アプリケーション ゲートウェイ名 | **az104-06-appgw5** |
    | リージョン | このラボでその他のすべてのリソースをデプロイした Azure リージョンの名前 |
    | レベル | **標準 V2** |
    | 自動スケーリングを有効にする | **いいえ** |
    | HTTP2 | **Disabled** |
    | 仮想ネットワーク | **az104-06-vnet01** |
    | Subnet | **subnet-appgw** |

1. **[次へ: フロントエンド >]** をクリックし、 **[アプリケーション ゲートウェイの作成]** ブレードの **[フロントエンド]** タブで、 **[新規追加]** をクリックして次の設定を指定します (その他の設定は既定値のままにします)。

    | 設定 | 値 |
    | --- | --- |
    | フロントエンド IP アドレス タイプ | **Public** |
    | パブリック IP アドレス| 新しいパブリック IP アドレス **az104-06-pip5** の名前 |

1. **[次へ: バックエンド >]** をクリックし、 **[アプリケーション ゲートウェイの作成]** ブレードの **[バックエンド]** タブで、 **[+ バックエンド プールの追加]** をクリックし、 **[バックエンド プールの追加]** ブレードで、次の設定を指定します (その他は既定値のままにします)。

    | 設定 | 値 |
    | --- | --- |
    | 名前 | **az104-06-appgw5-be1** |
    | [Add backend pool without targets]\(ターゲットを持たないバックエンド プールを追加する\) | **いいえ** |
    | 変換後の型 | **IP アドレスまたは FQDN** |
    | Target | **10.62.0.4** |
    | 変換後の型 | **IP アドレスまたは FQDN** |
    | Target | **10.63.0.4** |

    > **注**:ターゲットは、スポークバーチャル ネットワーク **az104-06-vm2** および **az104-06-vm3** 内の仮想マシンのプライベート IP アドレスを表します。

1. **[追加]** をクリックし、 **[次へ: 構成 >]** をクリックし、 **[アプリケーション ゲートウェイの作成]** ブレードの **[構成]** タブで、 **[+ ルーティング規則の追加]** をクリックします。

1. **「ルーティング規則の追加」** ブレードの **「リスナー」** タブで、次の設定を指定します。

    | 設定 | 値 |
    | --- | --- |
    | 規則の名前 | **az104-06-appgw5-rl1** |
    | Priority | "**10**" |
    | リスナー名 | **az104-06-appgw5-rl1l1** |
    | フロントエンド IP | **Public** |
    | Protocol | **HTTP** |
    | Port | **80** |
    | リスナーの種類 | **Basic** |
    | エラー ページの URL | **いいえ** |

1. 「**ルーティング規則の追加」** ブレードの **「バックエンド ターゲット」** タブに切り替え、次の設定を指定します (その他の設定は既定値のままにします)。

    | 設定 | 値 |
    | --- | --- |
    | 変換後の型 | **バックエンド プール** |
    | バックエンド ターゲット | **az104-06-appgw5-be1** |

1. **[Backend settings]\(バックエンド設定\)** テキスト ボックスの下にある **[新規追加]** をクリックし、 **[Add Backend setting]\(バックエンド設定の追加\)** ブレードで次の設定を指定します (その他の項目は既定値のままにします)。

    | 設定 | 値 |
    | --- | --- |
    | HTTP 設定名 | **az104-06-appgw5-http1** |
    | バックエンド プロトコル | **HTTP** |
    | バックエンド ポート | **80** |
    | Cookie ベースのアフィニティ | **Disable** |
    | 接続のドレイン | **Disable** |
    | 要求タイムアウト (秒) | **20** |

1. **「HTTP 設定の追加」** ブレードで **「追加」** をクリックし、 **「ルーティング規則の追加**」 ブレードに戻って **「追加」** をクリックします。

1. **[次へ: タグ >]** をクリックし、 **[次へ: 確認と作成 >]** 、 **[作成]** の順にクリックします。

    > **注**:Application Gateway インスタンスが作成されるのを待ちます。 8 分間程度かかる場合があります。

1. Azure portal で **「Application Gateways」** を検索して選択し、 **「Application Gateways」** ブレードで **「az104-06-appgw5」** をクリックします。

1. **「az104-06-appgw5** Application Gateway」 ブレードで、 **「フロントエンド パブリック IP アドレス」** の値を書き留めます。

1. 別のブラウザーのウィンドウを起動し、前の手順で識別した IP アドレスに移動します。

1. ブラウザー ウィンドウに、**Hello World from az104-06-vm2** または **Hello World from az104-06-vm3** というメッセージが表示されることを確認します。

1. 今度は InPrivate モードを使用して別のブラウザー ウィンドウを開き、Web ページに表示されるメッセージに基づいて、ターゲット VM が変更されたかどうかを確認します。

    > **注**:ブラウザー ウィンドウを更新するか、InPrivate モードを使用して再度開く必要があります。

    > **注**:複数のバーチャル ネットワーク上の仮想マシンを対象とすることは一般的な構成ではありませんが、Application Gateway が複数のバーチャル ネットワーク上の仮想マシンや、他の Azureリージョンのエンドポイント、さらには Azure の外部のエンドポイントを対象とできる点を示すことを目的としています。同じバーチャル ネットワーク内の仮想マシン間で負荷分散を行う Azure Load Balancer とは異なります。

#### <a name="clean-up-resources"></a>リソースをクリーンアップする

>**注**:新規に作成し、使用しなくなったすべての Azure リソースを削除することを忘れないでください。 使用していないリソースを削除することで、予期しない料金が発生しなくなります。

>**注**:ラボのリソースをすぐに削除できなくても心配する必要はありません。 リソースに依存関係が存在し、削除に時間がかかる場合があります。 リソースの使用状況を監視することは管理者の一般的なタスクであるため、ポータルでリソースを定期的にチェックして、クリーンアップの進捗を確認するようにしてください。 

1. Azure portal で、**[Cloud Shell]** ペイン内に **PowerShell** セッションを開きます。

1. 次のコマンドを実行して、このモジュールのラボ全体で作成したすべてのリソース グループのリストを表示します。

   ```powershell
   Get-AzResourceGroup -Name 'az104-06*'
   ```

1. 次のコマンドを実行して、このモジュールのラボ全体を通して作成したすべてのリソース グループを削除します。

   ```powershell
   Get-AzResourceGroup -Name 'az104-06*' | Remove-AzResourceGroup -Force -AsJob
   ```

    >**注**:このコマンドは非同期で実行されるため (-AsJob パラメーターによって決定されます)、同じ PowerShell セッション内で直後に別の PowerShell コマンドを実行できますが、リソース グループが実際に削除されるまでに数分かかります。

#### <a name="review"></a>確認

このラボでは、次のことを行いました。

+ ラボ環境をプロビジョニングしました
+ ハブとスポーク ネットワーク トポロジを構成しました
+ バーチャル ネットワーク ピアリングの推移性をテストしました
+ タスク 4: ハブ アンド スポーク トポロジでルーティングを構成する
+ タスク 5:Azure Load Balancer を実装する
+ タスク 6:Azure Application Gateway を実装する
